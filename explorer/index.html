

<!DOCTYPE html>
<html style="height:100%;">
  <head>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.js">
    </script>
    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
    <link rel="import" href="bower_components/paper-toast/paper-toast.html">
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/iron-icons/iron-icons.html">    
    <link rel="import" href="bower_components/paper-fab/paper-fab.html">
    <link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
    <link rel="import" href="bower_components/mat-editor/mat-editor.html">
    <link rel="import" href="bower_components/iron-flex-layout/classes/iron-flex-layout.html">
    <link rel="import" href="bower_components/iron-icons/hardware-icons.html">
    <link rel="import" href="venomous_explorer.html">
    <title>sample [Venomous Explorer]</title>
  
  <style type="text/css">
  #the_toast{
  }
  #save_button{
    position: absolute;
    right: 10px;
    bottom: 10px;
  }
  #xml_source_editor{
    width: 100%;
    height: 80%; /*TODO: this is suppsoed to be flex*/;
    padding: 0px;
  }
  #show_source_button{
    position: absolute;
    right: 10px;
    bottom: 80px;
    /* TODO: put fabs in a single container */
  }
  #dialog_xml_source {
      position: fixed;
      top: 40px;
      bottom: 40px;
      right: 40px;
      left: 40px;
  }
  </style>
  </head>
  
  <body style="height:100%;margin:0;">

  <iron-ajax id="ajax_load"
    url="sample.xml"
    handle-as="document"
  ></iron-ajax>
  
  <iron-ajax id="ajax_save"
    url="save"
    method="post"
  ></iron-ajax>

  <venomous-explorer  id="the_graph" style="height:100%; width: 100%; position:fixed;"></venomous-explorer>
  
  <paper-toast id="the_toast" duration="10000"> </paper-toast>
  <paper-fab icon="save" id="save_button"></paper-fab>
  <paper-fab icon="device:developer-mode" id="show_source_button"></paper-fab>
  
  <paper-dialog id="dialog_xml_source" modal="true" layout vertical>
  <h2>XML source</h2>
  <mat-editor id="xml_source_editor" mode="xml" line-numbers="true" flex></mat-editor>
  <div class="buttons">
    <paper-button dialog-dismiss>Close</paper-button>
    <paper-button dialog-confirm>Apply Changes</paper-button>
  </div>
  </paper-dialog>

  <script>
  "use strict";
 
  document.addEventListener('WebComponentsReady', function() { 

    // TODO: should just make a list and loop to auto set id as var on window
    window.ajax_load = document.getElementById("ajax_load");
    window.ajax_save = document.getElementById("ajax_save");
    window.the_graph = document.getElementById("the_graph");
    window.the_toast = document.getElementById("the_toast");
    window.save_button = document.getElementById("save_button");
    window.show_source_button = document.getElementById("show_source_button");
    window.dialog_xml_source = document.getElementById("dialog_xml_source");
    window.xml_source_editor = document.getElementById("xml_source_editor");


    save_button.addEventListener("click",function(e){
        var xml = the_graph.write_to_xml();
        var formData = new FormData();
        formData.append("file_to_be_saved", new Blob([xml], { type: "text/xml"}));
        formData.append("filename", "sample.xml");
        ajax_save.body = formData;
        ajax_save.generateRequest();
    })
    the_graph.addEventListener("error", function(e){
      the_toast.text = e.detail.type.toUpperCase() + ": "  + e.detail.msg;
      the_toast.show();
      console.dir(e.detail);
    })
    ajax_load.addEventListener("response", function(e){
      the_graph.load_from_xml(e.detail.response.childNodes);
    });
    ajax_load.generateRequest();
    ajax_save.addEventListener("response", function(e){
      if(e.detail.succeeded)
        the_toast.text = "Successfully saved";
      else
        the_toast.text = "ERROR: failed to save";
      the_toast.show();
    })
    show_source_button.addEventListener("click", function(){
      xml_source_editor.value = the_graph.write_to_xml();
      dialog_xml_source.open();
      xml_source_editor._refresh();     
      xml_source_editor.focus();
    })
  });

  </script>
  </body>
</html>