<!--
CUSTOM ELEMENT: venomous-explorer
BY: DM, but all the hard work is from [github.com/cpettitt/dagre-d3]


USEAGE:
    <venomous-explorer id="my_graph"></venomous-explorer>
    <script>
        document.getElementById('my_graph').Render(nodeList);
	</script>


	Some things I had to consult for various not-so-obvious bits and bobs...

	repating template details..
	https://github.com/Polymer/polymer/issues/1758 

	css binding...
	http://stackoverflow.com/a/30541458/2399799

	svg/template...
	http://stackoverflow.com/a/30821159/2399799
-->

<dom-module id="venomous-explorer">
   <link rel="import" href="bower_components/iron-flex-layout/classes/iron-flex-layout.html">
   <link rel="import" href="bower_components/paper-card/paper-card.html">
   <link rel="import" href="bower_components/iron-icons/iron-icons.html">
   <link rel="import" href="bower_components/iron-icons/hardware-icons.html">
  <style>

	#info{
	background: #eee;
	border-top: 1px solid #000;
	padding: 8px;
	overflow-y: scroll;
	}
	#main_zone{
	overflow-x: scroll;
	overflow-y: scroll;
	cursor: default;
    padding: 8px;
    height: 500px;
    background-color: #fafafa;
    position: relative;
	}
	::-webkit-scrollbar {
	width: 10px;
	height: 10px;
	}
	::-webkit-scrollbar-button {
	width: 0;
	height: 0;
	display: none;
	}
	::-webkit-scrollbar-thumb {
	background-color: rgba(0,0,0,0.2);
	-webkit-box-shadow: inset 1px 1px 0 rgba(0,0,0,0.10),inset 0 -1px 0 rgba(0,0,0,0.07);
	}
	.node{
		position: absolute;
		min-width: 80px;
		padding: 4px;
		text-align: center;
		font-family: 'Roboto', 'Noto', sans-serif;
		background-color: #fff;
	}
	.node[is_moving=true]{
		cursor: move;
	}
	.node_name{	
		vertical-align: bottom;
    	font-weight: bold;
	}
	.edge{
		position: absolute;
		top: 0px;
		left: 0px;
		width: 100%;
		height: 100%;
	}
	.noselect {
	  -webkit-touch-callout: none;
	  -webkit-user-select: none;
	  -khtml-user-select: none;
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	}
  </style>
  
  <template>
  	<div id="container" class="layout vertical" style="height:100%;">
	    <div id='main_zone' class="noselect" nodrag>	
	    	<!-- it would  be nice to have on svg node, and put the template inside it, but this is only possible with Polymer 0.5 not 1.0-->
	    	<template is="dom-repeat" items="{{vedges}}">
	    	<svg class="edge"> <line x1$="{{item.start_left}}" x2$="{{item.end_left}}" y1$="{{item.start_top}}" y2$="{{item.end_top}}"
	    	style="stroke:rgb(0,0,0);stroke-width:1"/></svg>
	    	</template>
	    	
	    	<template is="dom-repeat" items="{{vnodes}}">
			<paper-material class="node" style$="{{build_position_css(item.left,item.top)}}" index$="{{index}}" on-track="node_on_track"
			is_moving$="{{item.is_moving}}">
			<iron-icon style$="{{node_type_to_css(item.node_type)}}" icon="{{node_type_to_icon(item.node_type)}}"></iron-icon>
			<span class="node_name" style$="{{node_type_to_css(item.node_type)}}">{{item.name}}</span>
	    	</paper-material>
	    	</template>

	    </div>
		<div id='info' class="flex">
			This is the info
		</div>
	</div>
  </template>




  <script>
  var node_type_to_icon_mapping = {
  	input: 'icons:system-update-alt',
  	compute: 'hardware:laptop'
  }
  var node_type_to_css_mapping = {
  	input: 'color:#99f',
  	compute: 'color:#cc7'
  }
  var push_objs_vals_onto_array = function(arr, obj){
	for(var k in obj)if(obj.hasOwnProperty(k))
	    arr.push(obj[k]);
  }

    // element registration
    Polymer({
      is: "venomous-explorer",
      ready: function() {
      	this.push('vnodes',{name: 'dummy_a', left: 100, top: 40, node_type: 'compute'});
      	this.push('vnodes',{name: 'dummy_b', left: 290, top: 80, node_type: 'input'});

        this.push('vedges',{start_left: 210, start_top: 50, end_left: 290, end_top: 90});
     
      },
      build_position_css(left,top){
      	return "left:" + left + "px;top:" + top + "px;";
      },
      node_type_to_icon(node_type){
      	return node_type_to_icon_mapping[node_type];
      },
      node_type_to_css(node_type){
		return node_type_to_css_mapping[node_type];
      },
      node_on_track: function(e){
      	var idx = e.currentTarget.index;

        switch(e.detail.state) {
          case 'start':
            console.log('Tracking started on ' + idx);
            this.set('vnodes.' + idx + ".is_moving",'true')
            break;
          case 'track':
            this.set('vnodes.'+ idx + '.left',this.vnodes[idx].left + e.detail.ddx);
            this.set('vnodes.'+ idx + '.top',this.vnodes[idx].top + e.detail.ddy);
            break;
          case 'end':
            console.log('Tracking ended on ' + idx);
            this.set('vnodes.' + idx + ".is_moving",'')
            break;
        }
      },
      load_from_xml: function(root){
      		if(root.length > 1)
      			this.fire('error',{type: 'parse-error', msg: 'root should have only 1 child noed, the engine.'});
      		if(root[0].nodeName.toLowerCase() != "engine")
      			this.fire('error',{type: 'parse-error', msg: 'the top-level node should be an "engine".'});
			var engine = root[0]; 

			var inputs = {};
			var computes = {};
			
			for(var i=0;i< engine.childNodes.length; i++){
				var node = engine.childNodes[i];
				var node_name = node.nodeName.toLowerCase(); 
				if(node_name == "input"){
					var name = node.attributes.getNamedItem("name").value;
					inputs[name] = {name: name, node_type: 'input', left: 100 + i*5, top: 100};
				}
				if(node_name == "compute"){
					var name = node.attributes.getNamedItem("name").value;
					computes[name] = {name: name, node_type: 'compute', left: 100 + i*5, top: 200};
				}
			}

			var vnodes = [];
			push_objs_vals_onto_array(vnodes, inputs);
			push_objs_vals_onto_array(vnodes, computes);
			this.set('vnodes', vnodes);

      		console.dir(engine);
      		this.fire('error', {type: 'not-implemented', msg: 'need to actually implement parsing.'});
      },
      properties: {
      		vnodes: {type: Array,
      		        value: function() {return [];},
      		        notify: true},
      		vedges: {type: Array,
      		        value: function() {return [];},
      		        notify: true}

      }
    });
  </script>

</dom-module>



