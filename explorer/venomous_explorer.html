<!--
CUSTOM ELEMENT: venomous-explorer
BY: DM, but all the hard work is from [github.com/cpettitt/dagre-d3]


USEAGE:
    <venomous-explorer id="my_graph"></venomous-explorer>
    <script>
        document.getElementById('my_graph').Render(nodeList);
	</script>
    
nodeList must be an array of objects that have the following properties:
    .id - the index of the node in the nodeList array
    .name - string giving the display name of the node
    .directBefore - array of node ids which are to be shown as the parents of the current node
	
	The rendering is super messy...but it shows what we need for now.
	This whole thing is a pretty nasty, but it's getting towards a sensible encapsulation.
-->

<dom-module id="venomous-explorer">
   <link rel="import" href="bower_components/iron-flex-layout/classes/iron-flex-layout.html">

  <style>

	#info{
	background: #eee;
	border-top: 1px solid #000;
	padding: 8px;
	overflow-y: scroll;
	}
	#svg_wrapper{
	overflow-x: scroll;
	cursor: default;
    padding: 8px
	}
	::-webkit-scrollbar {
	width: 10px;
	height: 10px;
	}
	::-webkit-scrollbar-button {
	width: 0;
	height: 0;
	display: none;
	}
	::-webkit-scrollbar-thumb {
	background-color: rgba(0,0,0,0.2);
	-webkit-box-shadow: inset 1px 1px 0 rgba(0,0,0,0.10),inset 0 -1px 0 rgba(0,0,0,0.07);
	}
  </style>
  
  <template>
   <style>
	text {
      font-weight: 300;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
      font-size: 14px;
    }
    .edgePath path {
      stroke: #333;
      stroke-width: 1.5px;
      fill: none;
    }
    g > rect {
    	fill:none;
    	border-radius: 3px;
    	stroke-width: 3px;
    }
	g.input > rect {
	  stroke: #000000;
	}
	g.compute > rect{
	  stroke: #9999ff;
	}
	</style>
  	<div id="container" class="layout vertical" style="height:100%;">
	    <div id='svg_wrapper' nodrag><svg id="thesvg"></svg></div>
		<div id='info' class="flex"></div>
	</div>
  </template>


  <script src="bower_components/lodash/lodash.min.js"></script>
  <script src="bower_components/graphlib/dist/graphlib.core.js"></script>
  <script src="bower_components/d3/d3.min.js"></script>
  <script src="bower_components/dagre/dist/dagre.core.js"></script>
  <script src="bower_components/dagre-d3/dist/dagre-d3.core.js"></script>


  <script>

  	function escapeHtml(html){
	    var text = document.createTextNode(html);
	    var div = document.createElement('div');
	    div.appendChild(text);
	    return div.innerHTML;
	}

    // element registration
    Polymer({
      is: "venomous-explorer",

      Render: function(nodeList){
            // Create the input graph
			var g = new dagreD3.graphlib.Graph()
						  .setGraph({})
						  .setDefaultEdgeLabel(function() { return {}; });
            
            for(var i=0;i<nodeList.length;i++)
            	nodeList[i]['directAfter'] = [];

            for(var i=0;i<nodeList.length;i++){
            	for(var j=0;j<nodeList[i].directBefore.length;j++){
            		var before = nodeList[nodeList[i].directBefore[j]];
            		nodeList[i].directBefore[j] = before;
            		if(before)
	            		before.directAfter.push(nodeList[i]);
            	}
            }

			
            for(var i=0; i<nodeList.length;i++)
                g.setNode(i, {label: nodeList[i].name, class: nodeList[i].class_});
            
			var edgeStyles = [];
			
			
            for(var i=0; i<nodeList.length;i++)
                for(var j=0; j<nodeList[i].directBefore.length;j++){
                	var before = nodeList[i].directBefore[j];
                	if(!before)
                		continue;
					edgeStyles.push(before.directAfter.length > 4 ? 'opacity: 0.3;' : '');//if there are loads of things after the jth item then weaken the arrow opacity.
			        g.setEdge(before.id,i);
				}
            
            // Create the renderer
            var renderer = new dagreD3.render();
			

            // Disable pan and zoom
            //renderer.zoom(false);            
            
            svg = this.getElementsByTagName("svg")[0];
            // Run the renderer. This is what draws the final graph.
            var layout = renderer(d3.select(svg), g);

            // Center the graph
            var b = svg.getBBox();
            svg.setAttribute('width', b.width);
            svg.setAttribute('height', b.height);
			var elInfo = this.$.info;
			d3.select(svg).selectAll("rect").on("mouseover", function(){
				var id = d3.select(this).data()[0];
				if(id){
					elInfo.innerHTML = "<b>" + nodeList[id].name + "</b><br>" +
										"directly before: " + nodeList[id].directBefore.map(function(x){return x.name}).join(", ") + "<br>" +
										"directly after: " + nodeList[id].directAfter.map(function(x){return x.name}).join(", ") + "<br>" +
										('code' in nodeList[id] ? "<pre>" + escapeHtml(nodeList[id].code)  + "</pre>" : "");
				}else{
					elInfo.innerHTML = "move cursor over map for info";
				}
			});		  
            
			
			
      },

      properties: {
        // declare properties for the element's public API
      }
    });
  </script>

</dom-module>



